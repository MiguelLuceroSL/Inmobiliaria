@model Inmobiliaria.Models.Contrato

<h1>Crear Nuevo Contrato</h1>

<form asp-action="Create">
    <div class="mb-3">
        <label for="buscarInquilino">Buscar Inquilino</label>
        <input type="text" id="buscarInquilino" placeholder="Apellido, nombre o DNI..." />
        <select id="listaInquilinos" name="InquilinoId"></select>
        <button id="btnMasInq" type="button" style="display:none;">Traer 20 más</button>
    </div>
    <div class="mb-3">
        <label for="buscarInmueble">Buscar Inmueble</label>
        <input type="text" id="buscarInmueble" placeholder="Dirección o tipo..." />
        <select id="listaInmuebles" name="InmuebleId"></select>
        <button id="btnMasInm" type="button" style="display:none;">Traer 20 más</button>
    </div>
    <div class="mb-3">
        <label asp-for="fechaDesde" class="form-label"></label>
        <input asp-for="fechaDesde" class="form-control" type="date" />
        <span asp-validation-for="fechaDesde" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label asp-for="fechaHasta" class="form-label"></label>
        <input asp-for="fechaHasta" class="form-control" type="date" />
        <span asp-validation-for="fechaHasta" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label asp-for="monto" class="form-label"></label>
        <input asp-for="monto" class="form-control" type="number" step="0.01" />
        <span asp-validation-for="monto" class="text-danger"></span>
    </div>
    <button type="submit" class="btn btn-primary">Crear</button>
    <a asp-action="Index" class="btn btn-secondary">Cancelar</a>
</form>
@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        function setupBusqueda(inputId, selectId, btnMasId, url) {
            let offset = 0;
            let terminoActual = "";

            document.getElementById(inputId).addEventListener("keyup", function () {
                let valor = this.value;
                if (valor.length >= 3) {
                    offset = 0;
                    terminoActual = valor;
                    cargarResultados(true);
                }
            });

            document.getElementById(btnMasId).addEventListener("click", function () {
                offset += 20;
                cargarResultados(false);
            });

            function cargarResultados(limpiar) {
                fetch(`${url}?term=${encodeURIComponent(terminoActual)}&offset=${offset}`)
                    .then(response => response.json())
                    .then(data => {
                        let select = document.getElementById(selectId);
                        if (limpiar) select.innerHTML = "";

                        data.forEach(item => {
                            let option = document.createElement("option");
                            option.value = item.idInquilino ?? item.idInmueble;

                            if (item.apellido) {
                                option.textContent = `${item.apellido}, ${item.nombre} - ${item.dniInquilino}`;
                            } else {
                                option.textContent = `${item.direccion} (${item.tipo})`;
                            }
                            select.appendChild(option);
                        });

                        document.getElementById(btnMasId).style.display = data.length === 20 ? "inline-block" : "none";
                    });
            }
        }

        setupBusqueda("buscarInquilino", "listaInquilinos", "btnMasInq", "/Inquilinos/Buscar");
        setupBusqueda("buscarInmueble", "listaInmuebles", "btnMasInm", "/Inmuebles/Buscar");
    </script>
}